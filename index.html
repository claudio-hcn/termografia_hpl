<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Inspecci√≥n Termogr√°fica</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500&display=swap');

:root {
  --bg: #080b0f;
  --surface: #0f1318;
  --surface2: #161b22;
  --surface3: #1c2330;
  --border: #243040;
  --accent: #f59e0b;
  --accent-dim: rgba(245,158,11,0.12);
  --green: #22c55e;
  --red: #ef4444;
  --blue: #3b82f6;
  --text: #dde4ee;
  --text2: #8898aa;
  --text3: #4a5a6a;
  --mono: 'Share Tech Mono', monospace;
  --display: 'Barlow Condensed', sans-serif;
  --body: 'Barlow', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body { background:var(--bg); color:var(--text); font-family:var(--body); min-height:100vh; overflow-x:hidden; }

/* HEADER */
header { position:sticky; top:0; z-index:200; background:rgba(8,11,15,0.97); backdrop-filter:blur(12px); border-bottom:1px solid var(--border); }
.hdr { padding:0 14px; display:flex; align-items:center; justify-content:space-between; height:52px; gap:10px; }
.logo { display:flex; align-items:center; gap:8px; flex-shrink:0; }
.logo-hex { width:30px; height:30px; flex-shrink:0; background:var(--accent); clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%); display:flex; align-items:center; justify-content:center; font-size:13px; color:#000; }
.logo-title { font-family:var(--display); font-weight:900; font-size:15px; letter-spacing:.06em; }
.hdr-right { display:flex; align-items:center; gap:10px; flex-shrink:0; }
.prog-bar { width:70px; height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
.prog-fill { height:100%; background:linear-gradient(90deg,var(--accent),#fbbf24); transition:width .4s; }
.prog-pct { font-family:var(--mono); font-size:9px; color:var(--text3); }
.btn-export { background:var(--accent); color:#000; border:none; padding:6px 11px; font-family:var(--display); font-weight:800; font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer; border-radius:2px; white-space:nowrap; }

/* STATS BAR */
.stats-bar { display:flex; border-bottom:1px solid var(--border); background:var(--surface); }
.stat-item { flex:1; padding:6px 0; text-align:center; border-right:1px solid var(--border); }
.stat-item:last-child { border-right:none; }
.stat-n { font-family:var(--mono); font-size:18px; line-height:1; color:var(--accent); }
.stat-n.green { color:var(--green); }
.stat-n.red { color:var(--red); }
.stat-l { font-size:8px; color:var(--text3); letter-spacing:.1em; text-transform:uppercase; }

/* TABS */
.tabs { display:flex; border-bottom:1px solid var(--border); background:var(--surface); position:sticky; top:52px; z-index:150; }
.tab { flex:1; padding:10px 6px; text-align:center; font-family:var(--mono); font-size:10px; color:var(--text3); letter-spacing:.1em; text-transform:uppercase; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; user-select:none; }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); background:var(--accent-dim); }

/* VIEWS */
.view { display:none; padding:12px; }
.view.active { display:block; }

/* PANEL LIST */
.search { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:9px 12px; font-family:var(--mono); font-size:16px; border-radius:4px; outline:none; margin-bottom:10px; }
.search:focus { border-color:var(--accent); }
.search::placeholder { color:var(--text3); font-size:13px; }
.floor-lbl { padding:5px 10px; margin:8px 0 4px; font-family:var(--mono); font-size:9px; color:var(--accent); letter-spacing:.2em; text-transform:uppercase; background:rgba(245,158,11,0.06); border-radius:2px; }
.pi { display:flex; align-items:center; gap:10px; padding:12px; cursor:pointer; background:var(--surface); border:1px solid var(--border); border-left:3px solid transparent; border-radius:3px; margin-bottom:4px; transition:background .12s; }
.pi.active { border-left-color:var(--accent); background:rgba(245,158,11,0.07); }
.pi-num { font-family:var(--mono); font-size:11px; color:var(--text3); min-width:24px; }
.pi-name { font-family:var(--display); font-size:15px; font-weight:600; flex:1; line-height:1.2; }
.pi-dot { width:10px; height:10px; border-radius:50%; border:1px solid var(--border); flex-shrink:0; }
.pi-dot.done  { background:var(--green); border-color:var(--green); }
.pi-dot.warn  { background:var(--accent); border-color:var(--accent); }
.pi-dot.alert { background:var(--red); border-color:var(--red); }

/* FORM */
.form-area { display:flex; flex-direction:column; gap:14px; }
.no-sel { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:40vh; gap:12px; color:var(--text3); }
.no-sel-icon { font-size:40px; opacity:.25; }
.no-sel-txt { font-family:var(--mono); font-size:11px; letter-spacing:.15em; text-transform:uppercase; text-align:center; line-height:1.8; }

/* PANEL TITLE */
.ptb { background:var(--surface); border:1px solid var(--border); border-left:4px solid var(--accent); border-radius:3px; padding:12px 14px; }
.ptb-meta { font-family:var(--mono); font-size:9px; color:var(--text3); letter-spacing:.15em; text-transform:uppercase; }
.ptb-name { font-family:var(--display); font-weight:900; font-size:22px; letter-spacing:.04em; margin-top:2px; line-height:1.15; }
.ptb-floor { font-family:var(--mono); font-size:10px; color:var(--accent); margin-top:4px; }
.ptb-badge { margin-top:8px; display:flex; align-items:center; flex-wrap:wrap; gap:6px; }
.badge { display:inline-block; padding:3px 10px; font-family:var(--mono); font-size:10px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; border-radius:2px; }
.badge-pending  { background:rgba(255,255,255,.05); color:var(--text3); border:1px solid var(--border); }
.badge-complete { background:rgba(34,197,94,.15); color:var(--green); border:1px solid rgba(34,197,94,.3); }
.badge-warning  { background:rgba(245,158,11,.15); color:var(--accent); border:1px solid rgba(245,158,11,.3); }
.badge-alert    { background:rgba(239,68,68,.15); color:var(--red); border:1px solid rgba(239,68,68,.3); }

/* CARD */
.card { background:var(--surface); border:1px solid var(--border); border-radius:3px; overflow:hidden; }
.card-hdr { padding:9px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; background:var(--surface2); }
.card-icon { font-size:14px; }
.card-title { font-family:var(--display); font-weight:700; font-size:13px; letter-spacing:.06em; text-transform:uppercase; color:var(--text2); flex:1; }
.card-body { padding:14px; display:flex; flex-direction:column; gap:10px; }

/* FIELDS */
.field { display:flex; flex-direction:column; gap:5px; }
.field-lbl { font-family:var(--mono); font-size:9px; color:var(--text3); letter-spacing:.14em; text-transform:uppercase; }
.field-inp { background:var(--surface3); border:1px solid var(--border); color:var(--text); padding:10px 12px; font-family:var(--mono); font-size:16px; border-radius:3px; outline:none; width:100%; }
.field-inp:focus { border-color:var(--accent); }
.field-inp::placeholder { color:var(--text3); font-size:13px; }
.temp-big { font-family:var(--mono); font-size:30px; color:var(--accent); line-height:1; margin-top:2px; }
.temp-big .unit { font-size:14px; color:var(--text3); }

/* PHASES */
.phase-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
.phase-box { background:var(--surface3); border:1px solid var(--border); border-radius:3px; padding:10px 6px; text-align:center; position:relative; overflow:hidden; }
.phase-box::after { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.ph-r::after { background:var(--red); }
.ph-s::after { background:var(--green); }
.ph-t::after { background:var(--blue); }
.phase-lbl { font-family:var(--mono); font-size:10px; font-weight:700; letter-spacing:.2em; margin-bottom:6px; }
.ph-r .phase-lbl { color:var(--red); }
.ph-s .phase-lbl { color:var(--green); }
.ph-t .phase-lbl { color:var(--blue); }
.phase-inp { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:6px 4px; font-family:var(--mono); font-size:18px; font-weight:700; border-radius:2px; outline:none; width:100%; text-align:center; }
.ph-r .phase-inp:focus { border-color:var(--red); }
.ph-s .phase-inp:focus { border-color:var(--green); }
.ph-t .phase-inp:focus { border-color:var(--blue); }
.phase-inp::placeholder { color:var(--text3); font-size:12px; }
.phase-unit { font-family:var(--mono); font-size:9px; color:var(--text3); margin-top:4px; }
.balance-info { font-family:var(--mono); font-size:11px; color:var(--text3); text-align:center; min-height:16px; }

/* ‚îÄ‚îÄ IMAGE GALLERY ‚îÄ‚îÄ */
.img-gallery { display:flex; flex-direction:column; gap:8px; }
.img-count-badge { font-family:var(--mono); font-size:10px; color:var(--text3); }

/* Cada item de imagen */
.img-item {
  background:var(--surface3); border:1px solid var(--border); border-radius:3px; overflow:hidden;
}
/* Item marcado como hallazgo: borde rojo izquierdo */
.img-item.hallazgo { border-left:3px solid var(--red); }

/* Fila superior: nombre de archivo + botones */
.img-item-row {
  display:flex; align-items:center; gap:8px; padding:8px 10px;
}
.img-item-filename {
  font-family:var(--mono); font-size:11px; color:var(--text2); flex:1;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
/* Bot√≥n hallazgo */
.btn-hallazgo {
  flex-shrink:0; padding:4px 9px;
  border:1px solid var(--border); border-radius:2px;
  background:transparent; color:var(--text3);
  font-family:var(--mono); font-size:9px; letter-spacing:.08em;
  cursor:pointer; transition:all .15s; white-space:nowrap;
}
.btn-hallazgo.active {
  background:rgba(239,68,68,.15); border-color:var(--red); color:var(--red);
}
/* Bot√≥n quitar */
.btn-img-remove {
  flex-shrink:0; background:transparent; border:none;
  color:var(--text3); font-size:16px; cursor:pointer; padding:2px 4px;
  line-height:1; transition:color .15s;
}
.btn-img-remove:active { color:var(--red); }

/* Vista previa (solo hallazgos) */
.img-item-preview { position:relative; }
.img-item-preview img { width:100%; max-height:220px; object-fit:contain; display:block; background:var(--bg); }
.img-loading {
  padding:16px; text-align:center;
  font-family:var(--mono); font-size:10px; color:var(--text3); letter-spacing:.1em;
}

/* Campo descripci√≥n */
.img-item-desc {
  display:flex; align-items:center; border-top:1px solid var(--border);
}
.img-item-desc-icon { padding:0 10px; color:var(--text3); font-size:12px; flex-shrink:0; }
.img-item-desc-inp {
  flex:1; background:transparent; border:none; color:var(--text);
  font-family:var(--body); font-size:14px; padding:8px 8px 8px 0; outline:none;
}
.img-item-desc-inp::placeholder { color:var(--text3); }
.img-item-desc-inp:focus { border-bottom:1px solid var(--accent); margin-bottom:-1px; }

/* Estado vac√≠o */
.img-empty-state {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:6px; padding:24px; color:var(--text3);
  border:1px dashed var(--border); border-radius:3px;
}
.img-empty-icon { font-size:24px; opacity:.3; }
.img-empty-txt { font-family:var(--mono); font-size:10px; letter-spacing:.12em; }

/* Bot√≥n agregar imagen */
.btn-add-img {
  display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:11px;
  background:transparent; border:1px dashed var(--border); color:var(--text2); border-radius:3px;
  cursor:pointer; font-family:var(--display); font-weight:700; font-size:15px;
  letter-spacing:.06em; text-transform:uppercase; transition:all .15s;
}
.btn-add-img:active { border-color:var(--accent); color:var(--accent); border-style:solid; }

/* CHECKS */
.check-row { display:flex; align-items:center; justify-content:space-between; background:var(--surface3); border:1px solid var(--border); border-radius:3px; padding:11px 12px; gap:10px; }
.check-lbl { font-family:var(--display); font-weight:600; font-size:15px; color:var(--text2); }
.tgl-group { display:flex; gap:6px; }
.tgl { padding:8px 14px; border:1px solid var(--border); background:transparent; color:var(--text3); font-family:var(--mono); font-size:11px; letter-spacing:.08em; cursor:pointer; border-radius:3px; transition:all .12s; min-width:54px; }
.tgl.ok  { background:rgba(34,197,94,.2); border-color:var(--green); color:var(--green); }
.tgl.bad { background:rgba(239,68,68,.2); border-color:var(--red); color:var(--red); }

/* TEXTAREA */
.obs-ta { width:100%; min-height:90px; background:var(--surface3); border:1px solid var(--border); color:var(--text); padding:10px 12px; font-family:var(--body); font-size:15px; line-height:1.5; border-radius:3px; outline:none; resize:vertical; }
.obs-ta:focus { border-color:var(--accent); }
.obs-ta::placeholder { color:var(--text3); }

/* ACTION BAR */
.action-bar { display:grid; grid-template-columns:1fr 1fr; gap:8px; padding-bottom:28px; }
.btn { padding:12px; border:1px solid var(--border); border-radius:3px; font-family:var(--display); font-weight:700; font-size:14px; letter-spacing:.06em; text-transform:uppercase; cursor:pointer; transition:all .15s; text-align:center; background:var(--surface2); color:var(--text2); }
.btn:disabled { opacity:.3; cursor:default; }
.btn-save { background:var(--accent); color:#000; border-color:var(--accent); grid-column:1/-1; font-size:16px; padding:13px; }
.btn-clear { background:transparent; color:var(--text3); font-size:12px; grid-column:1/-1; }

/* TOAST */
.toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(80px); z-index:999; background:var(--green); color:#000; padding:10px 20px; border-radius:20px; font-family:var(--mono); font-size:12px; letter-spacing:.1em; opacity:0; transition:all .3s cubic-bezier(.34,1.56,.64,1); white-space:nowrap; }
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
.toast.err { background:var(--red); color:#fff; }

/* DESKTOP */
@media(min-width:700px) {
  .stats-bar { display:none; }
  .tabs { display:none; }
  .view { display:none !important; }
  .desktop-wrap { display:grid !important; grid-template-columns:280px 1fr; gap:18px; max-width:1400px; margin:0 auto; padding:18px; }
  .d-sidebar { display:flex !important; flex-direction:column; position:sticky; top:68px; height:calc(100vh - 86px); overflow-y:auto; background:var(--surface); border:1px solid var(--border); border-radius:3px; }
  .d-sidebar::-webkit-scrollbar { width:3px; }
  .d-sidebar::-webkit-scrollbar-thumb { background:var(--border); }
  .sb-head { padding:10px 12px; border-bottom:1px solid var(--border); }
  .sb-lbl { font-family:var(--mono); font-size:9px; color:var(--text3); letter-spacing:.18em; text-transform:uppercase; margin-bottom:6px; }
  .d-form { display:flex !important; flex-direction:column; gap:14px; }
  .hdr { height:58px; padding:0 20px; }
  .logo-title { font-size:17px; }
  .d-hdr-stats { display:flex !important; align-items:center; gap:16px; }
  .d-stat { display:flex; flex-direction:column; align-items:center; gap:1px; }
  .d-stat-n { font-family:var(--mono); font-size:18px; color:var(--accent); line-height:1; }
  .d-stat-n.green { color:var(--green); }
  .d-stat-n.red { color:var(--red); }
  .d-stat-l { font-size:9px; color:var(--text3); letter-spacing:.1em; text-transform:uppercase; }
  .vd { width:1px; height:28px; background:var(--border); }
  .d-prog { display:flex; flex-direction:column; align-items:center; gap:3px; }
  .d-prog-bar { width:110px; height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
  .thermo-2col { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .mobile-only { display:none !important; }
}
@media(max-width:699px) {
  .desktop-wrap { display:none !important; }
  .d-hdr-stats { display:none !important; }
}
</style>
</head>
<body>

<header>
  <div class="hdr">
    <div class="logo">
      <div class="logo-hex">‚ö°</div>
      <div class="logo-title">TERMOGRAF√çA</div>
    </div>
    <div class="hdr-right mobile-only">
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
        <div class="prog-bar"><div class="prog-fill" id="mProgFill" style="width:0%"></div></div>
        <span class="prog-pct" id="mProgPct">0%</span>
      </div>
      <button class="btn-export" onclick="exportCSV()">‚¨á CSV</button>
    </div>
    <div class="d-hdr-stats" style="display:none;">
      <div class="d-stat"><span class="d-stat-n" id="dStatTotal">73</span><span class="d-stat-l">Total</span></div>
      <div class="vd"></div>
      <div class="d-stat"><span class="d-stat-n green" id="dStatDone">0</span><span class="d-stat-l">Inspecc.</span></div>
      <div class="vd"></div>
      <div class="d-stat"><span class="d-stat-n red" id="dStatAlert">0</span><span class="d-stat-l">Alertas</span></div>
      <div class="vd"></div>
      <div class="d-prog">
        <div class="d-prog-bar"><div class="prog-fill" id="dProgFill" style="width:0%"></div></div>
        <span class="d-stat-l" id="dProgPct">0%</span>
      </div>
      <button class="btn-export" onclick="exportCSV()">‚¨á CSV</button>
    </div>
  </div>
</header>

<div class="stats-bar">
  <div class="stat-item"><div class="stat-n" id="mStatTotal">73</div><div class="stat-l">Total</div></div>
  <div class="stat-item"><div class="stat-n green" id="mStatDone">0</div><div class="stat-l">Listos</div></div>
  <div class="stat-item"><div class="stat-n red" id="mStatAlert">0</div><div class="stat-l">Alertas</div></div>
</div>

<div class="tabs">
  <div class="tab active" id="tab-list" onclick="showTab('list')">üìã Tableros</div>
  <div class="tab" id="tab-form" onclick="showTab('form')">üìù Formulario</div>
</div>

<div class="view active" id="view-list">
  <input class="search" type="text" placeholder="Buscar tablero..." id="mSearch" oninput="filterPanels()">
  <div id="mPanelList"></div>
</div>

<div class="view" id="view-form">
  <div class="form-area" id="mFormArea">
    <div class="no-sel">
      <span class="no-sel-icon">üîå</span>
      <span class="no-sel-txt">Seleccione un tablero<br>desde la pesta√±a Tableros</span>
    </div>
  </div>
</div>

<div class="desktop-wrap" style="display:none;">
  <div class="d-sidebar" style="display:none;">
    <div class="sb-head">
      <div class="sb-lbl">73 Tableros</div>
      <input class="search" type="text" placeholder="Buscar..." id="dSearch" oninput="filterPanels()">
    </div>
    <div id="dPanelList"></div>
  </div>
  <div class="d-form" style="display:none;" id="dFormArea">
    <div class="no-sel">
      <span class="no-sel-icon">üîå</span>
      <span class="no-sel-txt">Seleccione un tablero</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<!-- File input off-screen, only triggered by explicit button -->
<input type="file" id="globalImg" accept="image/*"
  style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;"
  onchange="handleImgChange(event)">

<script>
const PANELS=[{id:1,tag:"TABLERO S.A.",floor:"PISO SUBTERR√ÅNEO"},{id:2,tag:"TABLERO S.A.1",floor:"PISO SUBTERR√ÅNEO"},{id:3,tag:"TABLERO S.A.2",floor:"PISO SUBTERR√ÅNEO"},{id:4,tag:"TABLERO S.A.3",floor:"PISO SUBTERR√ÅNEO"},{id:5,tag:"TABLERO S.A.4",floor:"PISO SUBTERR√ÅNEO"},{id:6,tag:"TABLERO S.A.5",floor:"PISO SUBTERR√ÅNEO"},{id:7,tag:"TABLERO S.A.6",floor:"PISO SUBTERR√ÅNEO"},{id:8,tag:"TABLERO S.A.7",floor:"PISO SUBTERR√ÅNEO"},{id:9,tag:"TABLERO S.A.8",floor:"PISO SUBTERR√ÅNEO"},{id:10,tag:"TABLERO S.A.9",floor:"PISO SUBTERR√ÅNEO"},{id:11,tag:"TABLERO S.B.1",floor:"PISO SUBTERR√ÅNEO"},{id:12,tag:"TABLERO S.B.2",floor:"PISO SUBTERR√ÅNEO"},{id:13,tag:"TABLERO S.C",floor:"PISO SUBTERR√ÅNEO"},{id:14,tag:"TABLERO G.1",floor:"PISO SUBTERR√ÅNEO"},{id:15,tag:"TABLERO Z. A",floor:"PATIO GENERACI√ìN"},{id:16,tag:"TABLERO Z. A. 1",floor:"PISO Z√ìCALO"},{id:17,tag:"TABLERO Z. A. 2",floor:"PISO Z√ìCALO"},{id:18,tag:"TABLERO Z. B. L",floor:"PISO Z√ìCALO"},{id:19,tag:"TABLERO Z. B",floor:"PISO Z√ìCALO"},{id:20,tag:"TABLERO Z. B. 1",floor:"PISO Z√ìCALO"},{id:21,tag:"TABLERO Z. C",floor:"PISO Z√ìCALO"},{id:22,tag:"TABLERO Z. C. 1",floor:"PISO Z√ìCALO"},{id:23,tag:"TABLERO 1. A.",floor:"PRIMER PISO"},{id:24,tag:"TABLERO 1. A. 1",floor:"PRIMER PISO"},{id:25,tag:"TABLERO 1. A. 2",floor:"PRIMER PISO"},{id:26,tag:"TABLERO 1. A. 3",floor:"PRIMER PISO"},{id:27,tag:"TABLERO 1. A. 4",floor:"PRIMER PISO"},{id:28,tag:"TABLERO 1. B.",floor:"PRIMER PISO"},{id:29,tag:"TABLERO 1. C.",floor:"PRIMER PISO"},{id:30,tag:"TABLERO 2. A.",floor:"SEGUNDO PISO"},{id:31,tag:"TABLERO 2. A. 1",floor:"SEGUNDO PISO"},{id:32,tag:"TABLERO 2. A. 2",floor:"SEGUNDO PISO"},{id:33,tag:"TABLERO 2. C.",floor:"SEGUNDO PISO"},{id:34,tag:"TABLERO 3. A.",floor:"TERCER PISO"},{id:35,tag:"TABLERO 3. A. 1",floor:"TERCER PISO"},{id:36,tag:"TABLERO 3. A. 2",floor:"TERCER PISO"},{id:37,tag:"TABLERO 3. C.",floor:"TERCER PISO"},{id:38,tag:"TABLERO 4. A.",floor:"CUARTO PISO"},{id:39,tag:"TABLERO 4. A. 1",floor:"CUARTO PISO"},{id:40,tag:"TABLERO 4. A. 2",floor:"CUARTO PISO"},{id:41,tag:"TABLERO 4. A. 3",floor:"CUARTO PISO"},{id:42,tag:"TABLERO 5. A.",floor:"QUINTO PISO"},{id:43,tag:"TABLERO 5. A. 1",floor:"QUINTO PISO"},{id:44,tag:"TABLERO 5. A. 2",floor:"QUINTO PISO"},{id:45,tag:"TABLERO P1-P2",floor:"QUINTO PISO"},{id:46,tag:"TABLERO A. 6.",floor:"SEXTO PISO"},{id:47,tag:"TABLERO A. 7.",floor:"S√âPTIMO PISO"},{id:48,tag:"TABLERO P",floor:"PORTER√çA"},{id:49,tag:"TABLERO SALA DE CALDERAS CL-S.A.1",floor:"PISO SUBTERR√ÅNEO"},{id:50,tag:"TABLERO SALA DE CALDERAS CL-S.A.2",floor:"PISO SUBTERR√ÅNEO"},{id:51,tag:"TABLERO PISO 1A FAN COIL CL-1. A.1",floor:"PRIMER PISO"},{id:52,tag:"TABLERO PISO MEC√ÅNICO 2B CL-2. B.1",floor:"SEGUNDO PISO"},{id:53,tag:"TABLERO PISO MEC√ÅNICO 2B CL-2. B.2",floor:"SEGUNDO PISO"},{id:54,tag:"TABLERO PISO MEC√ÅNICO 2B CL-2. B.3",floor:"SEGUNDO PISO"},{id:55,tag:"TABLERO PISO MEC√ÅNICO 2B CL-2. B.4",floor:"SEGUNDO PISO"},{id:56,tag:"TABLERO PISO MEC√ÅNICO 3C CL-3. C.1",floor:"TERCER PISO"},{id:57,tag:"TABLERO PISO MEC√ÅNICO 3C CL-3. C.2",floor:"TERCER PISO"},{id:58,tag:"TABLERO VENTILADORES AISLADOS 3ER PISO",floor:"TERCER PISO"},{id:59,tag:"TABLERO PISO MEC√ÅNICO 6A CL-6. A.1",floor:"SEXTO PISO"},{id:60,tag:"TABLERO GENERAL EDIFICIO A",floor:"PISO SUBTERR√ÅNEO"},{id:61,tag:"TABLERO GENERAL EDIFICIO B Y C",floor:"PISO SUBTERR√ÅNEO"},{id:62,tag:"TABLERO BANCO CONDENSADORES EDIF. A",floor:"PISO SUBTERR√ÅNEO"},{id:63,tag:"TABLERO BANCO CONDENSADORES EDIF. B Y C",floor:"PISO SUBTERR√ÅNEO"},{id:64,tag:"TABLERO ACOPLADOR GENERAL",floor:"PISO SUBTERR√ÅNEO"},{id:65,tag:"TABLERO SALA CUNA",floor:"EXTERIOR ‚Äî SALA CUNA"},{id:66,tag:"TABLERO CONSEJO DESARROLLO (CODE)",floor:"EXTERIOR ‚Äî CONSEJO"},{id:67,tag:"TABLERO CLUB ESCOLAR 1",floor:"EXTERIOR ‚Äî CLUB ESCOLAR"},{id:68,tag:"TABLERO CLUB ESCOLAR 2",floor:"CLUB ESCOLAR"},{id:69,tag:"TABLERO RAYOS X",floor:"PRIMER PISO"},{id:70,tag:"TABLERO MAM√ìGRAFO",floor:"PRIMER PISO"},{id:71,tag:"TABLERO ASCENSORES CAMILLEROS",floor:"S√âPTIMO PISO"},{id:72,tag:"TABLERO ASCENSORES PERSONAS",floor:"S√âPTIMO PISO"},{id:73,tag:"TABLERO DE BOMBAS DE PETR√ìLEO",floor:"EXTERIOR"}];

const LS_KEY = 'termo_v4';
let records = {}, currentId = null;
let pendingImgs = [];
// pendingImgs items: { name, desc, hallazgo, src }
// - name:     nombre del archivo (siempre guardado, texto liviano)
// - desc:     descripci√≥n (texto)
// - hallazgo: true/false ‚Äî si es hallazgo, se guarda el src (Base64 comprimido)
// - src:      Base64 solo si hallazgo=true, '' en caso contrario

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadAll(){ try{ records=JSON.parse(localStorage.getItem(LS_KEY))||{}; }catch(e){ records={}; } }
function saveAll(){ localStorage.setItem(LS_KEY, JSON.stringify(records)); }
function getRec(id){ return records[id]||{tempAmb:'',tempMax:'',ir:'',is:'',it:'',limpieza:'',orden:'',obs:'',imgs:[],savedAt:null}; }

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStatus(id){
  const r=records[id];
  if(!r||!r.savedAt) return 'pending';
  if(r.limpieza==='bad'||r.orden==='bad') return 'alert';
  const v=[parseFloat(r.ir),parseFloat(r.is),parseFloat(r.it)].filter(x=>!isNaN(x)&&x>0);
  if(v.length===3){ const mx=Math.max(...v),mn=Math.min(...v); if(mx>0&&(mx-mn)/mx>0.2) return 'warn'; }
  return 'done';
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(t){
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('view-'+t).classList.add('active');
}

// ‚îÄ‚îÄ PANEL LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(cid, filter=''){
  const el=document.getElementById(cid); if(!el) return;
  const fl=filter.toLowerCase();
  const g={};
  PANELS.forEach(p=>{
    if(fl&&!p.tag.toLowerCase().includes(fl)&&!p.floor.toLowerCase().includes(fl)) return;
    if(!g[p.floor]) g[p.floor]=[];
    g[p.floor].push(p);
  });
  el.innerHTML=Object.entries(g).map(([f,ps])=>`
    <div class="floor-lbl">üìç ${f}</div>
    ${ps.map(p=>{
      const st=getStatus(p.id);
      const dc=st==='done'?'done':st==='warn'?'warn':st==='alert'?'alert':'';
      return `<div class="pi${currentId===p.id?' active':''}" onclick="selectPanel(${p.id})">
        <span class="pi-num">${String(p.id).padStart(2,'0')}</span>
        <span class="pi-name">${p.tag}</span>
        <span class="pi-dot ${dc}"></span>
      </div>`;
    }).join('')}
  `).join('')||'<p style="padding:16px;color:var(--text3);font-family:var(--mono);font-size:11px;text-align:center">Sin resultados</p>';
}

function filterPanels(){
  renderList('mPanelList', document.getElementById('mSearch')?.value||'');
  renderList('dPanelList', document.getElementById('dSearch')?.value||'');
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats(){
  let done=0, alerts=0;
  PANELS.forEach(p=>{ const s=getStatus(p.id); if(s!=='pending') done++; if(s==='alert') alerts++; });
  const pct=Math.round(done/PANELS.length*100);
  const $=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  $('mStatTotal',PANELS.length); $('mStatDone',done); $('mStatAlert',alerts);
  $('dStatTotal',PANELS.length); $('dStatDone',done); $('dStatAlert',alerts);
  $('mProgPct',pct+'%'); $('dProgPct',pct+'%');
  ['mProgFill','dProgFill'].forEach(id=>{ const e=document.getElementById(id); if(e) e.style.width=pct+'%'; });
}

// ‚îÄ‚îÄ IMAGE GALLERY HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildGalleryHtml(imgs){
  if(!imgs||!imgs.length){
    return `<div class="img-empty-state">
      <span class="img-empty-icon">üì∑</span>
      <span class="img-empty-txt">Sin referencias de im√°genes</span>
    </div>`;
  }
  return imgs.map((img,i)=>`
    <div class="img-item${img.hallazgo?' hallazgo':''}">
      <div class="img-item-row">
        <span class="img-item-filename">üìé ${img.name}</span>
        <button class="btn-hallazgo${img.hallazgo?' active':''}" type="button" onclick="toggleHallazgo(${i})">
          ${img.hallazgo?'‚ö† Hallazgo':'‚ö† Marcar'}
        </button>
        <button class="btn-img-remove" type="button" onclick="removeImg(${i})">√ó</button>
      </div>
      ${img.hallazgo
        ? img.src
          ? `<div class="img-item-preview"><img src="${img.src}" alt="${img.name}"></div>`
          : `<div class="img-loading">‚è≥ Cargando imagen...</div>`
        : ''
      }
      <div class="img-item-desc">
        <span class="img-item-desc-icon">‚úèÔ∏è</span>
        <input class="img-item-desc-inp" type="text"
          placeholder="Descripci√≥n o referencia..."
          value="${(img.desc||'').replace(/"/g,'&quot;')}"
          oninput="updateImgDesc(${i},this.value)">
      </div>
    </div>
  `).join('');
}

function refreshGalleries(){
  document.querySelectorAll('.img-gallery').forEach(g=> g.innerHTML=buildGalleryHtml(pendingImgs));
  document.querySelectorAll('.img-count-badge').forEach(b=>{
    const total=pendingImgs.length;
    const hall=pendingImgs.filter(i=>i.hallazgo).length;
    b.textContent = total ? `(${total}${hall?` ¬∑ ‚ö†${hall}`:''})` : '';
  });
}

// ‚îÄ‚îÄ COMPRIMIR IMAGEN (solo para hallazgos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function compressImage(file, callback){
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=900;
      const scale=Math.min(1, MAX/img.width);
      const canvas=document.createElement('canvas');
      canvas.width=Math.round(img.width*scale);
      canvas.height=Math.round(img.height*scale);
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      callback(canvas.toDataURL('image/jpeg', 0.65));
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ TOGGLE HALLAZGO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Al marcar como hallazgo: carga y comprime la foto desde el dispositivo
// Al desmarcar: elimina el src (libera memoria), solo queda el nombre
function toggleHallazgo(idx){
  const img=pendingImgs[idx]; if(!img) return;
  if(img.hallazgo){
    // desmarcar ‚Üí borrar foto, conservar solo nombre y desc
    img.hallazgo=false;
    img.src='';
    img._file=null;
    refreshGalleries();
  } else {
    // marcar ‚Üí pedir foto
    img.hallazgo=true;
    img.src=''; // mostrar loading mientras carga
    refreshGalleries();
    // abrir picker apuntando a este √≠ndice
    window._hallazgoIdx=idx;
    const fi=document.getElementById('hallazgoImg');
    fi.value=''; fi.click();
  }
}

// ‚îÄ‚îÄ IMAGE HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Agregar referencia (solo nombre, sin foto)
function triggerImg(){
  const fi=document.getElementById('globalImg');
  fi.value=''; fi.click();
}

function handleImgChange(e){
  const file=e.target.files[0]; if(!file) return;
  // Solo guarda nombre. Sin Base64. Costo: ~20 bytes.
  pendingImgs.push({ name:file.name, desc:'', hallazgo:false, src:'' });
  refreshGalleries();
}

// Cargar foto para hallazgo (comprimida)
function handleHallazgoChange(e){
  const file=e.target.files[0]; if(!file) return;
  const idx=window._hallazgoIdx;
  if(idx===undefined||!pendingImgs[idx]) return;
  compressImage(file, src=>{
    pendingImgs[idx].src=src;
    refreshGalleries();
  });
}

function removeImg(idx){
  pendingImgs.splice(idx,1);
  refreshGalleries();
}

function updateImgDesc(idx,val){
  if(pendingImgs[idx]) pendingImgs[idx].desc=val;
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildForm(id){
  const p=PANELS.find(x=>x.id===id);
  const r=getRec(id);
  const st=getStatus(id);
  const idx=PANELS.findIndex(x=>x.id===id);
  const prev=idx>0?PANELS[idx-1].id:null;
  const next=idx<PANELS.length-1?PANELS[idx+1].id:null;
  const bc=st==='done'?'badge-complete':st==='warn'?'badge-warning':st==='alert'?'badge-alert':'badge-pending';
  const bt=st==='done'?'‚úì Inspeccionado':st==='warn'?'‚ö† Revisar':st==='alert'?'‚úï Anomal√≠a':'‚óã Pendiente';
  const tCol=v=>{ const n=parseFloat(v); return isNaN(n)||!v?'var(--accent)':n>60?'var(--red)':n>40?'var(--accent)':'var(--green)'; };
  const imgCount=pendingImgs.length;
  const hallCount=pendingImgs.filter(i=>i.hallazgo).length;

  return `
  <div class="ptb">
    <div class="ptb-meta">√çTEM ${String(id).padStart(2,'0')} de ${PANELS.length}</div>
    <div class="ptb-name">${p.tag}</div>
    <div class="ptb-floor">üìç ${p.floor}</div>
    <div class="ptb-badge">
      <span class="badge ${bc}">${bt}</span>
      ${r.savedAt?`<span style="font-family:var(--mono);font-size:9px;color:var(--text3)">‚è± ${new Date(r.savedAt).toLocaleString('es-CL',{hour12:false,day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>`:''}
    </div>
  </div>

  <div class="card">
    <div class="card-hdr"><span class="card-icon">üå°Ô∏è</span><span class="card-title">Temperatura</span></div>
    <div class="card-body">
      <div class="thermo-2col">
        <div class="field">
          <label class="field-lbl">Temperatura Ambiente (¬∞C)</label>
          <input class="field-inp" type="number" step="0.1" inputmode="decimal" id="f_tempAmb" placeholder="ej: 22.5" value="${r.tempAmb}">
        </div>
        <div class="field">
          <label class="field-lbl">Temp. M√°xima Detectada (¬∞C)</label>
          <input class="field-inp" type="number" step="0.1" inputmode="decimal" id="f_tempMax" placeholder="ej: 45.3" value="${r.tempMax}" oninput="liveTemp()">
          <div class="temp-big" id="tempBig" style="color:${tCol(r.tempMax)}">${r.tempMax||'‚Äî'}<span class="unit">${r.tempMax?'¬∞C':''}</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr">
      <span class="card-icon">üì∑</span>
      <span class="card-title">Im√°genes</span>
      <span class="img-count-badge">${imgCount?`(${imgCount}${hallCount?` ¬∑ ‚ö†${hallCount}`:''})`:''}</span>
    </div>
    <div class="card-body">
      <div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:.1em;line-height:1.6;">
        Agrega referencias de tus fotos (nombre del archivo).<br>
        Marca como <b style="color:var(--red)">‚ö† Hallazgo</b> solo las que necesites ver.
      </div>
      <div class="img-gallery">${buildGalleryHtml(pendingImgs)}</div>
      <button class="btn-add-img" type="button" onclick="triggerImg()">
        üìé &nbsp;Agregar referencia de imagen
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr"><span class="card-icon">‚ö°</span><span class="card-title">Corrientes por L√≠nea (A)</span></div>
    <div class="card-body">
      <div class="phase-grid">
        <div class="phase-box ph-r"><div class="phase-lbl">R</div><input class="phase-inp" type="number" step="0.1" min="0" inputmode="decimal" id="f_ir" placeholder="‚Äî" value="${r.ir}"><div class="phase-unit">AMPERIOS</div></div>
        <div class="phase-box ph-s"><div class="phase-lbl">S</div><input class="phase-inp" type="number" step="0.1" min="0" inputmode="decimal" id="f_is" placeholder="‚Äî" value="${r.is}"><div class="phase-unit">AMPERIOS</div></div>
        <div class="phase-box ph-t"><div class="phase-lbl">T</div><input class="phase-inp" type="number" step="0.1" min="0" inputmode="decimal" id="f_it" placeholder="‚Äî" value="${r.it}"><div class="phase-unit">AMPERIOS</div></div>
      </div>
      <div class="balance-info" id="balInfo"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr"><span class="card-icon">üîç</span><span class="card-title">Estado del Tablero</span></div>
    <div class="card-body">
      <div class="check-row" data-field="f_limpieza" data-value="${r.limpieza}">
        <span class="check-lbl">üßπ Limpieza</span>
        <div class="tgl-group">
          <button class="tgl ${r.limpieza==='ok'?'ok':''}" type="button" onclick="setCheck('f_limpieza','ok')">‚úì OK</button>
          <button class="tgl ${r.limpieza==='bad'?'bad':''}" type="button" onclick="setCheck('f_limpieza','bad')">‚úï MAL</button>
        </div>
      </div>
      <div class="check-row" data-field="f_orden" data-value="${r.orden}">
        <span class="check-lbl">üîå Orden / Cableado</span>
        <div class="tgl-group">
          <button class="tgl ${r.orden==='ok'?'ok':''}" type="button" onclick="setCheck('f_orden','ok')">‚úì OK</button>
          <button class="tgl ${r.orden==='bad'?'bad':''}" type="button" onclick="setCheck('f_orden','bad')">‚úï MAL</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr"><span class="card-icon">üìù</span><span class="card-title">Observaciones</span></div>
    <div class="card-body">
      <textarea class="obs-ta" id="f_obs" placeholder="Anomal√≠as detectadas, recomendaciones...">${r.obs}</textarea>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn" ${!prev?'disabled':''} onclick="${prev?`selectPanel(${prev})`:''}" type="button">‚Üê Anterior</button>
    <button class="btn" ${!next?'disabled':''} onclick="${next?`selectPanel(${next})`:''}" type="button">Siguiente ‚Üí</button>
    <button class="btn btn-save" onclick="saveRec(${id})" type="button">üíæ Guardar Registro</button>
    <button class="btn btn-clear" onclick="clearRec(${id})" type="button">üóë Limpiar datos</button>
  </div>`;
}

// ‚îÄ‚îÄ SELECT PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectPanel(id){
  currentId=id;
  // Carga copia de trabajo: refs sin hallazgo no tienen src, hallazgos s√≠
  pendingImgs=(getRec(id).imgs||[]).map(i=>({...i}));
  const html=buildForm(id);
  document.getElementById('mFormArea').innerHTML=html;
  document.getElementById('dFormArea').innerHTML=html;
  ['f_ir','f_is','f_it'].forEach(fid=>{
    document.querySelectorAll('#'+fid).forEach(el=>el.addEventListener('input',liveBalance));
  });
  liveBalance();
  filterPanels();
  if(window.innerWidth<700){ showTab('form'); window.scrollTo({top:0,behavior:'smooth'}); }
}

// ‚îÄ‚îÄ LIVE UPDATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function liveTemp(){
  const v=document.getElementById('f_tempMax')?.value;
  const el=document.getElementById('tempBig'); if(!el) return;
  const n=parseFloat(v);
  const c=isNaN(n)||!v?'var(--accent)':n>60?'var(--red)':n>40?'var(--accent)':'var(--green)';
  el.style.color=c;
  el.innerHTML=`${v||'‚Äî'}<span class="unit">${v?'¬∞C':''}</span>`;
}

function liveBalance(){
  const g=fid=>{ const e=document.getElementById(fid); return e?parseFloat(e.value):NaN; };
  const rv=g('f_ir'),sv=g('f_is'),tv=g('f_it');
  const info=document.getElementById('balInfo'); if(!info) return;
  const vals=[rv,sv,tv].filter(v=>!isNaN(v)&&v>0);
  if(vals.length===3){
    const mx=Math.max(...vals),mn=Math.min(...vals),avg=(vals.reduce((a,b)=>a+b)/3).toFixed(1);
    const imb=((mx-mn)/mx*100).toFixed(1);
    const c=imb>20?'var(--red)':imb>10?'var(--accent)':'var(--green)';
    info.innerHTML=`Promedio: <b>${avg} A</b> ¬∑ Desbalance: <b style="color:${c}">${imb}%</b>${parseFloat(imb)>20?' ‚ö†':''}`;
  } else info.textContent='';
}

// ‚îÄ‚îÄ CHECKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setCheck(fid,val){
  document.querySelectorAll(`[data-field="${fid}"]`).forEach(row=>{
    row.dataset.value=val;
    const tgls=row.querySelectorAll('.tgl');
    tgls.forEach(t=>t.classList.remove('ok','bad'));
    if(val==='ok') tgls[0].classList.add('ok');
    if(val==='bad') tgls[1].classList.add('bad');
  });
}
function getCheck(fid){ const r=document.querySelector(`[data-field="${fid}"]`); return r?r.dataset.value||'':''; }

// ‚îÄ‚îÄ SAVE / CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveRec(id){
  records[id]={
    tempAmb: document.getElementById('f_tempAmb')?.value||'',
    tempMax: document.getElementById('f_tempMax')?.value||'',
    ir:      document.getElementById('f_ir')?.value||'',
    is:      document.getElementById('f_is')?.value||'',
    it:      document.getElementById('f_it')?.value||'',
    limpieza:getCheck('f_limpieza'),
    orden:   getCheck('f_orden'),
    obs:     document.getElementById('f_obs')?.value||'',
    // Guardamos: nombre+desc siempre; src solo si es hallazgo
    imgs: pendingImgs.map(i=>({
      name: i.name,
      desc: i.desc||'',
      hallazgo: i.hallazgo||false,
      src: i.hallazgo ? (i.src||'') : ''   // <-- costo real solo en hallazgos
    })),
    savedAt: Date.now()
  };
  saveAll(); updateStats(); filterPanels();
  showToast('‚úì Registro guardado');
  const html=buildForm(id);
  document.getElementById('mFormArea').innerHTML=html;
  document.getElementById('dFormArea').innerHTML=html;
  ['f_ir','f_is','f_it'].forEach(fid=>{
    document.querySelectorAll('#'+fid).forEach(el=>el.addEventListener('input',liveBalance));
  });
  liveBalance();
}

function clearRec(id){
  if(!confirm('¬øEliminar todos los datos de este tablero?')) return;
  delete records[id]; pendingImgs=[];
  saveAll(); updateStats(); selectPanel(id);
  showToast('üóë Registro limpiado',true);
}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(){
  const h=['Item','Tag','Piso','T.Amb(¬∞C)','T.Max(¬∞C)','I_R(A)','I_S(A)','I_T(A)','Limpieza','Orden','Observaciones','Im√°genes (nombre ¬∑ desc ¬∑ hallazgo)','Fecha'];
  const rows=PANELS.map(p=>{
    const r=records[p.id]||{};
    const imgsList=(r.imgs||[]).map(img=>{
      let s=img.name;
      if(img.desc) s+=` ¬∑ ${img.desc}`;
      if(img.hallazgo) s+=` [HALLAZGO]`;
      return s;
    }).join(' | ');
    return [
      p.id, `"${p.tag}"`, `"${p.floor}"`,
      r.tempAmb||'', r.tempMax||'',
      r.ir||'', r.is||'', r.it||'',
      r.limpieza||'', r.orden||'',
      `"${(r.obs||'').replace(/"/g,'""')}"`,
      `"${imgsList}"`,
      r.savedAt?new Date(r.savedAt).toLocaleString('es-CL'):''
    ].join(',');
  });
  const csv=[h.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`termografia_${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); showToast('‚¨á CSV exportado');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(isErr?' err':'');
  void t.offsetWidth; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadAll(); filterPanels(); updateStats();
</script>

<!-- Input para hallazgo (carga foto comprimida) -->
<input type="file" id="hallazgoImg" accept="image/*"
  style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;"
  onchange="handleHallazgoChange(event)">
</body>
</html>
